<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>RPG風 手動配置マップ + 外部読み込み</title>
<style>
body { margin:0; background:#222; overflow:hidden; }
canvas { display:block; margin:auto; background:#333; }
</style>
</head>
<body>

<canvas id="game"></canvas>

<!-- 外部マップデータ -->
<script src="map.json"></script>

<script>
// ================================
// 基本設定
// ================================
const TILE = 32;

// canvas は固定サイズ
const canvas = document.getElementById("game");
canvas.width  = 100 * TILE;
canvas.height = 80 * TILE;
const ctx = canvas.getContext("2d");

// ------------- マップ読み込み -------------
let map = MAP_DATA;   // map.js の MAP_DATA を読み込み
const mapRows = map.length;
const mapCols = map[0].length;

// ================================
// プレイヤー設定
// ================================
const player = { x:5, y:5 };

let keys = {};
document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup",   e => keys[e.key.toLowerCase()] = false);

// ================================
// 移動制御
// ================================
let moveCooldown = 0;
const NORMAL_INTERVAL = 15;
const WATER_INTERVAL = NORMAL_INTERVAL * 4; // 1/4 速度
const GRASS_INTERVAL = NORMAL_INTERVAL * 2; // 1/2 速度

// 移動可能地形
function canMove(x,y){
    if(x<0 || x>=mapCols || y<0 || y>=mapRows) return false;

    const t = map[y][x];
    return (t === 0 || t === 1 || t === 2 || t === 4 || t === 7);
}

// 同時押しの斜め移動を禁止
function getSingleDirection(){
    let up = keys["arrowup"] || keys["w"];
    let down = keys["arrowdown"] || keys["s"];
    let left = keys["arrowleft"] || keys["a"];
    let right = keys["arrowright"] || keys["d"];

    let count = (up?1:0)+(down?1:0)+(left?1:0)+(right?1:0);

    if(count !== 1) return null;

    if(up) return {dx:0, dy:-1};
    if(down) return {dx:0, dy:1};
    if(left) return {dx:-1, dy:0};
    if(right) return {dx:1, dy:0};
}

function movePlayer(){
    if(moveCooldown > 0){
        moveCooldown--;
        return;
    }

    let dir = getSingleDirection();
    if(!dir) return;

    let nx = player.x + dir.dx;
    let ny = player.y + dir.dy;

    if(!canMove(nx, ny)) return;

    player.x = nx;
    player.y = ny;

    // 速度変更
    const t = map[ny][nx];
    if(t === 2) moveCooldown = WATER_INTERVAL;      // 水 1/4
    else if(t === 1) moveCooldown = GRASS_INTERVAL; // 草 1/2
    else moveCooldown = NORMAL_INTERVAL;            // 通常
}

// ================================
// 描画
// ================================
function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    let camX = player.x - Math.floor(canvas.width/TILE/2);
    let camY = player.y - Math.floor(canvas.height/TILE/2);
    camX = Math.max(0, Math.min(camX, mapCols - canvas.width/TILE));
    camY = Math.max(0, Math.min(camY, mapRows - canvas.height/TILE));

    for(let y=0; y<mapRows; y++){
        for(let x=0; x<mapCols; x++){
            const sx = (x - camX) * TILE;
            const sy = (y - camY) * TILE;

            if(sx < -TILE || sy < -TILE || sx > canvas.width || sy > canvas.height)
                continue;

            let color;
            switch(map[y][x]){
                case 0: color = "#0F0"; break;       // 地面
                case 1: color = "#6F6"; break;       // 草
                case 2: color = "#0AF"; break;       // 水
                case 3: color = "#964B00"; break;    // 山
                case 4: color = "#D8A55A"; break;    // 橋（明るい木）
                case 5: color = "#228B22"; break;    // 木
                case 6: color = "#555"; break;       // 壁
                case 7: color = "#CCC"; break;       // 床
            }

            if(x === player.x && y === player.y) color = "#000";

            ctx.fillStyle = color;
            ctx.fillRect(sx, sy, TILE, TILE);
            ctx.strokeStyle = "#222";
            ctx.strokeRect(sx, sy, TILE, TILE);
        }
    }
}

// ================================
// メインループ
// ================================
function loop(){
    movePlayer();
    draw();
    requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
